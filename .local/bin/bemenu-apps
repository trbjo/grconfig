#!/usr/bin/zsh

/usr/bin/pgrep -x bemenu && exit

IFS=$'\n'
typeset -a list

[[ $commands[firefox] ]] && list+=(" Firefox" " Firefox (Private Window)" " IRC")
[[ $commands[subl] ]] && list+=(" Sublime Text")
[[ $commands[emacs] ]] && list+=(" Emacs")
[[ $commands[smerge] ]] && list+=(" Sublime Merge")
[[ $commands[baobab] ]] && list+=(" Disk Usage")
[[ $commands[gnome-disks] ]] && list+=(" Disk Utility")
[[ $commands[telegram-desktop] ]] && list+=(" Telegram")
[[ $commands[pavucontrol] ]] && list+=(" SoundControl")
[[ $commands[libreoffice] ]] && list+=(" LibreOffice Writer" " LibreOffice Calc" " LibreOffice Draw" " LibreOffice Impress" )

[[ $commands[darkmode] ]] &&  {
    theme="$(gsettings get org.gnome.desktop.interface gtk-theme)"
    if [[ $theme  == "'Adwaita'" ]]; then
        list+=(" Dark Mode")
    else
        list+=(" Light Mode")
    fi
}

[[ $commands[wf-recorder] ]] && {
    if pgrep -x wf-recorder > /dev/null 2>&1; then
        recorder="Stop Recording"
    else
        recorder="Record Desktop"
    fi
    list+=(" $recorder")
}

[[ $commands[code] ]] && list+=(" VSCode")
[[ $commands[grim] ]] && list+=(" Screenshot (Whole Screen)" " Screenshot (Whole Screen, Delay)") && \
[[ $commands[slurp] ]] && list+=(" Screenshot (Subset)")
[[ $commands[foot] ]] && list+=(" Foot Terminal")
[[ $commands[quicknotes.py] ]] && list+=(" Add to Quicknotes" " Open Quicknotes")
[[ $commands[wl-paste] ]] && list+=(" Upload Clipboard" " Upload Clipboard (Primary)")

[[ $commands[iwctl] ]] && {
    if systemctl is-active --quiet iwd; then
        wifi="OFF"
    else
        wifi="ON"
    fi
    list+=(" Turn WiFi $wifi")
}


[[ $commands[swaylock] ]] && list+=(" Lock")
[[ $commands[chromium-snapshot-bin] ]] && list+=(" Discord")

[[ "$HOST" == "teliarch" ]] && list+=(" Slack" " Teams")
[[ $commands[dbus-send] ]] && list+=(" Suspend" " Reboot" " Poweroff")

case $(bemenu -f --fork --prompt 'Programs' <<< ${${list[@]/#/  }/%/   }) in
    '   Firefox   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad'
        swaymsg -q --  '[app_id="^firefox$" tiling] focus' || swaymsg exec /usr/bin/firefox
        ;;


    '   Firefox (Private Window)   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^firefox$" tiling] focus'
        swaymsg -q -- '[title="Mozilla\ Firefox\ \(Private\ Browsing\)$"] focus' || swaymsg exec /usr/bin/firefox --private-window
        ;;

    '   IRC   ')
        swaymsg -q -- '[app_id="^PopUp$"] move scratchpad; [title="^chat.sr.ht\ —\ Mozilla\ Firefox$"] focus' || swaymsg exec /usr/bin/firefox --new-window --kiosk https://chat.sr.ht/
        ;;


    '  ↓↑ Show Download Speed   ')
        interface=/sys/class/net/wlan0
        readable() {
            local bytes=$1
            local kib=$(( bytes >> 10 ))
            if [ $kib -lt 0 ]; then
                printf "? K"
            elif [ $kib -gt 1024 ]; then
                local mib_int=$(( kib >> 10 ))
                local mib_dec=$(( kib % 1024 * 976 / 10000 ))
                if [ "$mib_dec" -lt 10 ]; then
                    mib_dec="0${mib_dec}"
                fi

                if [ "${mib_dec:1:2}" -ge 9 ]; then
                    mib_dec="0"
                    mib_int=$(( mib_int + 1))
                elif [ "${mib_dec:1:2}" -ge 5 ]; then
                    mib_dec=$(( ${mib_dec:0:1} + 1 ))
                else
                    mib_dec=$(( ${mib_dec:0:1} ))
                fi
                printf "${mib_int}.${mib_dec}Mb/s"
            else
                printf "${kib}Kb/s"
            fi
        }

        swaymsg -- "bindsym escape exec 'swaymsg -- unbindsym escape; exec pkill -f \"zsh $0\"'"

        while true; do
            read last_rx < "${interface}/statistics/rx_bytes"
            read last_tx < "${interface}/statistics/tx_bytes"
            sleep 1
            read rx < "${interface}/statistics/rx_bytes"
            read tx < "${interface}/statistics/tx_bytes"
            notify-send "↓$(readable $((rx - last_rx)))" "↑$(readable $((tx - last_tx)))" --app-name='NETSPEED'
        done
        ;;


    '   Sublime Text   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^sublime_text$"] focus'
        /opt/sublime_text/sublime_text
        ;;


    '   Emacs   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^emacs$"] focus' || /usr/bin/emacs
        ;;


    '   Disk Usage   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^baobab$"] focus'
        swaymsg exec /usr/bin/baobab
        ;;


    '   Disk Utility   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^gnome-disks$"] focus'
        swaymsg exec /usr/bin/gnome-disks
        ;;


    '   Stop Recording   ')
        pkill -SIGINT wf-recorder
        notify-send.sh "Recording saved" "$curdate" --expire-time=5000 --icon=camera-video --default-action="xdg-open $HOME/vid/"
        ;;


    '   Record Desktop   ')
        integer active_outputs
        active_outputs=$(swaymsg -t get_tree | jq -r '[. | (.nodes? // empty)[] | select(.type=="output" and .name!="__i3") ] | length')
        if (( active_outputs > 1)); then
            export XCURSOR_SIZE=48
            output="$(slurp -w 1 -c A5BAD1 -s C3DFFE94 -f "%l" -o)"
            if [[ -z $output ]]; then
                exit
            fi
        fi
        curdate=$(date +"Recording_%Y-%m-%d_%H:%M:%S.mp4")
        notify-send "Recording Desktop in 3 seconds" "Press ctrl+c to stop it" --icon=camera-video
        sleep 1
        notify-send "Recording Desktop in 2 seconds" "Press ctrl+c to stop it" --icon=camera-video
        sleep 1
        notify-send "Recording Desktop in 1 seconds" "Press ctrl+c to stop it" --icon=camera-video
        sleep 1
        swaymsg -- "bindsym ctrl+c exec pkill -SIGINT wf-recorder && swaymsg -- unbindsym ctrl+c && notify-send.sh 'Recording saved' '$curdate' --expire-time=5000 --icon=camera-video --default-action=\"xdg-open $HOME/vid/\""
        if (( active_outputs > 1)); then
            wf-recorder -o "$output" -f ~/vid/$curdate
        else
            wf-recorder -f ~/vid/$curdate
        fi
        ;;


    '   Telegram   ')
        export DESKTOP_APP_I_KNOW_ABOUT_GTK_INCOMPATIBILITY=1
        export DESKTOP_APP_DISABLE_TRAY_COUNTER=1
        export TDESKTOP_I_KNOW_ABOUT_GTK_INCOMPATIBILITY=1
        export TDESKTOP_DISABLE_TRAY_COUNTER=1
        export TDESKTOP_USE_PORTAL=1
        export TDESKTOP_USE_GTK_FILE_DIALOG=1
        grep --color=auto -q 'enabled' /sys/class/drm/card0-DP-1/enabled && export ALSA_CARD=Audio
        readlink -q /sys/bus/hid/devices/0003:047F:02F7* > /dev/null 2>&1 && export ALSA_CARD=BT600
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="-Telegram_Desktop$"] focus'
        /usr/bin/telegram-desktop
        ;;


    '   VSCode   ')
        electron13 /usr/lib/code/out/cli.js /usr/lib/code/code.js --enable-features=UseOzonePlatform --ozone-platform=wayland
        ;;


    '   Slack   ')
        swaymsg -q -- '[app_id="^PopUp$"] move scratchpad'
        swaymsg -q -- '[app_id="^\/usr\/bin\/chromium-snapshot-bin$" title="^Slack"] focus' ||\
        /usr/bin/chromium-snapshot-bin  --enable-features=UseOzonePlatform --ozone-platform=wayland --app='https://app.slack.com/client/T03PATMPV/D02D6BJLB5Z' &!
        ;;


    '   Dark Mode   ')
        /home/tb/.local/bin/darkmode dark
        ;;


    '   Light Mode   ')
        /home/tb/.local/bin/darkmode light
        ;;


    '   Teams   ')
        swaymsg -q -- '[app_id="^PopUp$"] move scratchpad'
        swaymsg -q -- '[app_id="^microsoft-edge-dev$"] focus' ||\
        /opt/microsoft/msedge-dev/microsoft-edge-dev --enable-features=UseOzonePlatform --ozone-platform=wayland 'teams.microsoft.com'
        ;;


    '   Discord   ')
        swaymsg -q -- '[app_id="^PopUp$"] move scratchpad'
        swaymsg -q -- '[app_id="\/usr\/bin\/chromium-snapshot-bin$" title=^(?!(Slack.*|.*Chromium|.*Microsoft.Teams)).*$] focus' ||\
        /usr/bin/chromium-snapshot-bin --enable-features=UseOzonePlatform --ozone-platform=wayland --app='https://discord.com/channels/280102180189634562/280102180189634562'
        ;;


    '   SoundControl   ')
        /usr/bin/pavucontrol
        ;;


    '   LibreOffice Writer   ')
        libreoffice --writer
        ;;


    '   LibreOffice Calc   ')
        libreoffice --calc
        ;;


    '   LibreOffice Draw   ')
        libreoffice --draw
        ;;


    '   LibreOffice Impress   ')
        libreoffice --impress
        ;;


    '   Lock   ')
        /usr/bin/loginctl lock-session
        ;;


    '   Turn WiFi ON   ')
        message() {
            notify-send "Wi-Fi Manager" "$1" --icon=preferences-system-network
        }
        /usr/bin/pkill -RTMIN+13 i3blocks
        doas /usr/bin/systemctl start iwd.service
        doas /usr/bin/rfkill unblock wifi
        message "Turning Wi-Fi on"
        /usr/lib/systemd/systemd-networkd-wait-online --ignore=lo --timeout=30 --interface=wlan0 --operational-state=dormant && message "Connected to $( iw dev wlan0 link | grep -oP '(?<=SSID: ).+')"&& /usr/bin/pkill -RTMIN+13 i3blocks && /usr/bin/pkill -RTMIN+14 i3blocks
        pkill -RTMIN+13 i3blocks
        ;;


    '   Turn WiFi OFF   ')
        notify-send "Wi-Fi Manager" "Turning Wi-Fi off" --icon=preferences-system-network
        doas /usr/bin/systemctl stop iwd.service
        doas /usr/bin/rfkill block wifi
        /usr/bin/pkill -RTMIN+13 i3blocks
        ;;


    '   Suspend   ')
        /usr/bin/dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 "org.freedesktop.login1.Manager.Suspend" boolean:true
        ;;


    '   Hibernate   ')
        dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 "org.freedesktop.login1.Manager.Hibernate" boolean:true
        ;;


    '   Reboot   ')
        /usr/bin/dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 "org.freedesktop.login1.Manager.Reboot" boolean:true
        ;;


    '   Poweroff   ')
        /usr/bin/dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 "org.freedesktop.login1.Manager.PowerOff" boolean:true
        ;;


    '   Sublime Merge   ')
        swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^sublime_merge$"] focus'
        if pgrep -x sublime_text; then
            /opt/sublime_text/sublime_text --fwdargv0 "$0" --command goto_sublime_current_dir
        fi
        /opt/sublime_merge/sublime_merge --fwdargv0 "$0" "$(cat /tmp/sublfile)" || /opt/sublime_merge/sublime_merge
        ;;


    '   Screenshot (Whole Screen)   ')
        /usr/bin/pgrep slurp || {
            curdate=$(date +"Screenshot_%Y-%m-%d_%H:%M:%S.png")
            screenshot=$HOME/screenshots/$curdate
            grim $screenshot && notify-send.sh "Screenshot taken" "$curdate" --icon=camera-photo --default-action="xdg-open $screenshot"
            wl-copy < "$screenshot"
            swaymsg -- "bindsym return exec xdg-open \"$screenshot\" && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
            swaymsg -- "bindsym escape exec makoctl dismiss && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
        }
        ;;


    '   Screenshot (Whole Screen, Delay)   ')
        /usr/bin/pgrep slurp || {
            notify-send "Taking Screenshot in 3 seconds" --icon=camera-video
            sleep 1
            notify-send "Taking Screenshot in 2 seconds" --icon=camera-video
            sleep 1
            notify-send "Taking Screenshot in 1 second" --icon=camera-video
            sleep 1

            curdate=$(date +"Screenshot_%Y-%m-%d_%H:%M:%S.png")
            screenshot=$HOME/screenshots/$curdate
            grim $screenshot && notify-send.sh "Screenshot taken" "$curdate" --icon=camera-photo --default-action="xdg-open $screenshot"
            wl-copy < "$screenshot"
            swaymsg -- "bindsym return exec xdg-open \"$screenshot\" && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
            swaymsg -- "bindsym escape exec makoctl dismiss && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
        }
        ;;


    '   Screenshot (Subset)   ')
        /usr/bin/pgrep slurp || {
            curdate=$(date +"Screenshot_%Y-%m-%d_%H:%M:%S.png")
            screenshot=$HOME/screenshots/$curdate
            export XCURSOR_SIZE=48
            swaymsg -t get_tree | jq -r ".. | select(.pid? and .visible?) | .rect | \"\\(.x),\\(.y) \\(.width)x\\(.height)\"" | slurp -w 1 -c A5BAD1 -s C3DFFE94 | grim -g - "$screenshot" && {
            notify-send.sh "Screenshot taken" "$curdate" --icon=camera-photo --default-action="xdg-open \"$screenshot\""
            swaymsg -- "bindsym return exec xdg-open \"$url\" && swaymsg -- unbindsym return"
            wl-copy < "$screenshot"
            swaymsg -- "bindsym return exec xdg-open \"$screenshot\" && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
            swaymsg -- "bindsym escape exec makoctl dismiss && swaymsg -- unbindsym return && swaymsg -- unbindsym escape"
            }
        }
        ;;



    '   Upload Clipboard   ')
        set -o noglob
        tmpfile=$(mktemp /tmp/pastedata-XXXX)
        wl-paste > $tmpfile
        url=$(curl -s --data-binary "@$tmpfile" "https://paste.c-net.org/")
        if [[ -z "$url" ]]; then
            notify-send.sh "Upload failed" "Failed to upload clipboard" --icon=dialog-error
            exit
        fi
        swaymsg -- "bindsym return exec xdg-open \"$url\" && swaymsg -- unbindsym return"
        wl-copy -n "$url"
        notify-send.sh "Uploaded paste" "Uploaded to Pastebin" --default-action="xdg-open $url" --icon=gtk-network
        ;;


    '   Upload Clipboard (Primary)   ')
        set -o noglob
        tmpfile=$(mktemp /tmp/pastedata-XXXX)
        wl-paste --primary >> $tmpfile
        url=$(curl -s --data-binary "@$tmpfile" "https://paste.c-net.org/")
        if [[ -z "$url" ]]; then
            notify-send.sh "Upload failed" "Failed to upload clipboard" --icon=dialog-error
            exit
        fi
        swaymsg -- "bindsym return exec xdg-open \"$url\" && swaymsg -- unbindsym return"
        wl-copy -n "$url"
        notify-send.sh "Uploaded paste" "Uploaded to Pastebin" --default-action="xdg-open $url" --icon=gtk-network
        ;;


    '   Open Quicknotes   ')
            swaymsg -q --  '[app_id="^PopUp$"] move scratchpad; [app_id="^sublime_text$"] focus'
            /opt/sublime_text/sublime_text $HOME/quicknotes.md
        ;;


    '   Add to Quicknotes   ')
        quicknotes.py
        ;;


    '   Foot Terminal   ')
        /usr/bin/foot
        ;;


    *)
        # elems=$(swaymsg -t get_tree | jq -r '[.. | ((.floating_nodes,.nodes)? // empty)[] | select(.pid and .visible)] | length')
        # (( elems == 1 )) && swaymsg fullscreen enable
        ;;




esac
